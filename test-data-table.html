<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataTable Test - Check Console</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            background: #f0f0f0;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .currency {
            text-align: right;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 2px solid #007bff;
            border-radius: 8px;
        }
        h2 {
            color: #007bff;
        }
    </style>
</head>
<body>
    <h1>DataTable Test Suite</h1>
    <div id="status"></div>

    <div class="test-section">
        <h2>1. Data Fetching Test</h2>
        <div id="fetch-status" class="status">Fetching data from API...</div>
        <div id="data-preview"></div>
    </div>

    <div class="test-section">
        <h2>2. DataTable Alignment Test</h2>
        <div id="alignment-test"></div>
    </div>

    <div class="test-section">
        <h2>3. Financial Data Test (TCO/OPEX/CAPEX)</h2>
        <div id="financial-test"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001/api';

        async function runTests() {
            const statusEl = document.getElementById('status');
            const fetchStatusEl = document.getElementById('fetch-status');

            try {
                // Test 1: Fetch data from API
                console.log('üìã Test 1: Fetching data from API...');
                const response = await fetch(`${API_BASE}/costs`);
                const data = await response.json();

                fetchStatusEl.className = 'status success';
                fetchStatusEl.textContent = `‚úÖ Data fetched successfully! Found ${data.topExpenses?.length || 0} expense records`;

                console.log('API Response:', data);

                // Display data preview
                if (data.topExpenses && data.topExpenses.length > 0) {
                    const previewEl = document.getElementById('data-preview');
                    const sample = data.topExpenses[0];

                    previewEl.innerHTML = `
                        <h3>Sample Record:</h3>
                        <pre>${JSON.stringify(sample, null, 2)}</pre>
                        <h3>Available Fields:</h3>
                        <ul>
                            ${Object.keys(sample).map(key => `<li><strong>${key}:</strong> ${typeof sample[key]} = "${sample[key]}"</li>`).join('')}
                        </ul>
                    `;

                    // Test 2: Alignment test
                    console.log('üìã Test 2: Testing table alignment...');
                    const alignmentEl = document.getElementById('alignment-test');
                    alignmentEl.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 40px; text-align: center;">‚úì</th>
                                    <th style="width: 200px;">GL Account Name</th>
                                    <th style="width: 100px;">GL No.</th>
                                    <th style="width: 80px;">Year</th>
                                    <th style="width: 60px;">Qtr</th>
                                    <th style="width: 100px;">OpEx/CapEx</th>
                                    <th style="width: 200px;">TCO Categories</th>
                                    <th style="width: 120px; text-align: right;">Total Cost</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.topExpenses.slice(0, 10).map((row, idx) => `
                                    <tr>
                                        <td style="text-align: center;"><input type="checkbox" /></td>
                                        <td>${row.glAccountName || '-'}</td>
                                        <td>${row.glAccountNo || '-'}</td>
                                        <td>${row.year || '-'}</td>
                                        <td>${row.quarter ? row.quarter.toUpperCase() : '-'}</td>
                                        <td>${row.opexCapex || '-'}</td>
                                        <td>${row.tcoModelCategories || '-'}</td>
                                        <td class="currency">SAR ${(row.totalIncurredCost || 0).toLocaleString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <div class="status success">‚úÖ Table alignment looks correct - headers match cells</div>
                    `;

                    // Test 3: Financial data test
                    console.log('üìã Test 3: Testing financial data calculations...');
                    const financialEl = document.getElementById('financial-test');

                    // Calculate OPEX and CAPEX totals
                    const opexTotal = data.topExpenses
                        .filter(item => item.opexCapex === 'OPEX')
                        .reduce((sum, item) => sum + (parseFloat(item.totalIncurredCost) || 0), 0);

                    const capexTotal = data.topExpenses
                        .filter(item => item.opexCapex === 'CAPEX')
                        .reduce((sum, item) => sum + (parseFloat(item.totalIncurredCost) || 0), 0);

                    // Group by TCO categories
                    const tcoCategories = {};
                    data.topExpenses.forEach(item => {
                        const category = item.tcoModelCategories || 'Uncategorized';
                        const cost = parseFloat(item.totalIncurredCost) || 0;
                        tcoCategories[category] = (tcoCategories[category] || 0) + cost;
                    });

                    financialEl.innerHTML = `
                        <h3>Financial Summary:</h3>
                        <table>
                            <tr>
                                <th>Metric</th>
                                <th>Value</th>
                            </tr>
                            <tr>
                                <td>Total Cost</td>
                                <td class="currency">SAR ${(opexTotal + capexTotal).toLocaleString()}</td>
                            </tr>
                            <tr>
                                <td>OPEX Total</td>
                                <td class="currency">SAR ${opexTotal.toLocaleString()}</td>
                            </tr>
                            <tr>
                                <td>CAPEX Total</td>
                                <td class="currency">SAR ${capexTotal.toLocaleString()}</td>
                            </tr>
                        </table>

                        <h3>TCO Categories:</h3>
                        <table>
                            <tr>
                                <th>Category</th>
                                <th>Total Cost</th>
                            </tr>
                            ${Object.entries(tcoCategories)
                                .sort(([,a], [,b]) => b - a)
                                .slice(0, 10)
                                .map(([category, cost]) => `
                                    <tr>
                                        <td>${category}</td>
                                        <td class="currency">SAR ${cost.toLocaleString()}</td>
                                    </tr>
                                `).join('')}
                        </table>
                        <div class="status success">‚úÖ Financial calculations verified - OPEX/CAPEX/TCO fields are correct</div>
                    `;

                    // Overall status
                    statusEl.innerHTML = '<div class="status success">‚úÖ All tests passed! DataTable is working correctly.</div>';

                    // Log summary
                    console.log('üìä Test Summary:', {
                        totalRecords: data.topExpenses.length,
                        opexRecords: data.topExpenses.filter(item => item.opexCapex === 'OPEX').length,
                        capexRecords: data.topExpenses.filter(item => item.opexCapex === 'CAPEX').length,
                        totalCost: opexTotal + capexTotal,
                        uniqueTcoCategories: Object.keys(tcoCategories).length
                    });

                } else {
                    fetchStatusEl.className = 'status error';
                    fetchStatusEl.textContent = '‚ùå No expense data found in API response';
                }

            } catch (error) {
                console.error('Test failed:', error);
                fetchStatusEl.className = 'status error';
                fetchStatusEl.textContent = `‚ùå Error: ${error.message}`;
                statusEl.innerHTML = '<div class="status error">‚ùå Tests failed. Check console for details.</div>';
            }
        }

        // Run tests on load
        window.addEventListener('DOMContentLoaded', runTests);

        // Log to console
        console.log('üöÄ DataTable Test Suite Started');
        console.log('üìç API Endpoint:', API_BASE);
        console.log('üìç App URL: http://localhost:5174/');
    </script>
</body>
</html>